# Modifying code to bypass AV

## Attack tree

```text
1 Use a different payload (OR)
2 Change payload settings (OR)
3 Change code
    3.1 Modify source code (OR)
        3.1.1 It is not the shellcode itself (AND)
        3.1.2 Playing with the params and formats 
    3.2 Modify compiled code in hex editor
        3.2.1 Replacing ascii code with exactly the same amout of characters
4 Make payloads using existing templates
5 Make payloads from scratch
```

## Notes

Whether delivering a payload through an application vulnerability exploit, or through social engineering, running code 
on target machines is part of most penetration testing. That means bypassing antivirus software or other host-based 
protections.

AV programs use database of signatures to detect malware. Modifying backdoor code will change its signature.

* Open backdoor with text editor.
* Make sure shellcode is not detected, if it is then change payload settings or use a different one.
* Remove all arguments, add them one by one to identify the one triggering AV programs
* Remove/modify detectable code.
* Test whether still detected

Some parts of the code may be doing nothing:

* Open file with hex editor.
* Change values that donâ€™t affect code execution.
* Make small changes and save and test the file whether still executes.
* Test whether still detected.

Note that creating a new payload or shellcode that creates a new signature that is not present in the antivirus' tools 
database can still be effective but falls short on the new solutions that base their detection on heuristics 
and behavioural analysis. Learn to write your own payloads using existing templates for example, or from scratch in
python, in which case:

* Include finding out what AV and protections the target uses in reconnaisance.
* Keep it as simple as possible.

## Tools

* [NoDistribute](https://nodistribute.com/)
* [AntiScan](https://antiscan.me/)
* [KleenScan.com](https://kleenscan.com)

## Cheatsheets

* [Windows antivirus](cheatsheets:docs/payloads/av-windows)
* [Linux antivirus](cheatsheets:docs/payloads/av-linux)
* [Evasion engineering examples](cheatsheets:docs/payloads/evasion-engineering)

## Scripting

* [Nirridit (Evil files)](https://github.com/tymyrddin/nirridit)
* [Ymrir (Network hacking scripts)](https://github.com/tymyrddin/ymrir)